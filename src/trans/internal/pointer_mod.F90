MODULE POINTER_MOD

USE PARKIND1, ONLY : JPRB, JPIM

IMPLICIT NONE

INTEGER, PARAMETER :: &
    & NTYPE_VOR  = B'00000000000000000000000000000001', &
    & NTYPE_DIV  = B'00000000000000000000000000000010', &
    & NTYPE_U    = B'00000000000000000000000000000100', &
    & NTYPE_V    = B'00000000000000000000000000001000', &
    & NTYPE_S    = B'00000000000000000000000000010000', &
    & NTYPE_EW   = B'00000000000000000000000000100000', &
    & NTYPE_NS   = B'00000000000000000000000001000000', &
    & NTYPE_U_EW = IOR (NTYPE_U, NTYPE_EW), &
    & NTYPE_V_EW = IOR (NTYPE_V, NTYPE_EW), &
    & NTYPE_S_EW = IOR (NTYPE_S, NTYPE_EW), &
    & NTYPE_S_NS = IOR (NTYPE_S, NTYPE_NS)

TYPE PTRS
  REAL (KIND=JPRB), POINTER :: P (:) => NULL ()
  INTEGER (KIND=JPIM) :: ITYPE   = 0
  INTEGER (KIND=JPIM) :: IPTR    = -99999
  INTEGER (KIND=JPIM) :: IPTR_NS = -99999
  CHARACTER*16 :: CLNAME = ''
END TYPE

TYPE PTRG
  REAL (KIND=JPRB), POINTER :: P (:,:) => NULL ()
  INTEGER (KIND=JPIM) :: ITYPE   = 0
  INTEGER (KIND=JPIM) :: IVSET   = 0
  INTEGER (KIND=JPIM) :: IRANK_L = 0
  INTEGER (KIND=JPIM) :: IRANK_G = 0
END TYPE

CONTAINS

FUNCTION GREP_G2S (YDGP, PGTF, KVSET, KTYPE) RESULT (YLSP)

TYPE (PTRS), ALLOCATABLE :: YLSP (:)

TYPE (PTRG) :: YDGP (:)
REAL (KIND=JPRB), TARGET, OPTIONAL :: PGTF (:,:)
INTEGER, OPTIONAL :: KTYPE, KVSET

INTEGER :: ICOUNT, J, JPASS

DO JPASS = 1, 2

  ICOUNT = 0
  
  DO J = 1, SIZE (YDGP)

    IF (PRESENT (KTYPE)) THEN
      IF (YDGP (J)%ITYPE /= KTYPE) CYCLE
    ENDIF

    IF (PRESENT (KVSET)) THEN
      IF (YDGP (J)%IVSET /= KVSET) CYCLE
    ENDIF

    ICOUNT = ICOUNT + 1

    IF (ALLOCATED (YLSP)) THEN
      IF (PRESENT (PGTF)) THEN
        YLSP (ICOUNT)%P => PGTF (YDGP (J)%IRANK_L, :)
      ENDIF
      YLSP (ICOUNT)%ITYPE = YDGP (J)%ITYPE
    ENDIF

  ENDDO

  IF (JPASS == 1) THEN
    ALLOCATE (YLSP (ICOUNT))
  ENDIF

ENDDO

END FUNCTION

FUNCTION GREP_S2S (YDSP, KTYPE) RESULT (YLSP)

TYPE (PTRS), ALLOCATABLE :: YLSP (:)

TYPE (PTRS) :: YDSP (:)
INTEGER, OPTIONAL :: KTYPE

INTEGER :: ICOUNT, J, JPASS

DO JPASS = 1, 2

  ICOUNT = 0
  
  DO J = 1, SIZE (YDSP)

    IF (PRESENT (KTYPE)) THEN
      IF (YDSP (J)%ITYPE /= KTYPE) CYCLE
    ENDIF

    ICOUNT = ICOUNT + 1

    IF (ALLOCATED (YLSP)) THEN
      YLSP (ICOUNT)%P => YDSP (J)%P
      YLSP (ICOUNT)%ITYPE = YDSP (J)%ITYPE
      YLSP (ICOUNT)%IPTR  = YDSP (J)%IPTR
    ENDIF

  ENDDO

  IF (JPASS == 1) THEN
    ALLOCATE (YLSP (ICOUNT))
  ENDIF

ENDDO

END FUNCTION

END MODULE
